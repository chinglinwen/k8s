# source file

# default base
base=data

makebase () {
  base="$1"
  mkdir $base 2>/dev/null
  echo "hey tests: $base"
  echo "服务名	并发数	QPS	ok(200)	502	504"
}

t () {
  name=$1
  time=$2
  c=$3
  url=$4
  RATE=$5
  rate=${RATE:=0}
  out="$name-$time-$n"
  lsout="$( ls $base | grep -w $out  )"
  count="$( echo "$lsout" | wc -l | awk '{ print $1 }' )"
  ((count++))
  if [ "x$lsout" = "x" ]; then
    count=1
  fi
  out="$name-$time-$c.$count.out"

  #echo "start $name time=$time, concurrent=$n, output file=$out"
  outfile=$base/$out
  echo "start time: $( date +%F_%T )" >> $outfile

  if [ "x$rate" = "x" ]; then
    extra="-q $rate"
  fi
  echo $time | grep -e '[a-z]' >/dev/null
  if [ $? -eq 0 ]; then
    unit="T=$time"
    echo "hey -z $time -c $c $extra $url >> $outfile" > $outfile
    hey -z $time -c $c $extra $url >> $outfile
  else
    n="$time"
    unit="N=$n"
    echo "hey -n $n -c $c $extra $url >> $outfile" > $outfile
    hey -n $n -c $c $extra $url >> $outfile
  fi
    
  echo "end time: $( date +%F_%T )" >> $outfile
  
  qps="$( grep Requests $outfile |awk '{ print $2 }' FS=':' |tr -d '\t'|cut -d'.' -f1 )"
  ok="$( grep '\[200\]' $outfile |awk '{ print $2 }' |tr -d '\t' )"
  elapse="$( grep Total $outfile |awk '{ print $2 }' FS=':' |tr -d '\t'|cut -d'.' -f1 )"
  e502="$( grep '\[502\]' $outfile |awk '{ print $2 }' |tr -d '\t' )"
  e504="$( grep '\[504\]' $outfile |awk '{ print $2 }' |tr -d '\t' )"
  echo -e "result:\t$name-$time-v$count($unit)\t$c\t$qps\t$ok\t$e502\t$e504" >> $outfile
  echo -e "$name-v$count($unit)\t$c\t$qps\t$ok\t$e502\t$e504" 
}


